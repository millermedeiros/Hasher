<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<link rel="stylesheet" href="./qunit/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="./qunit/qunit.js"></script>
		<script type="text/javascript" src="../../lib/js-signals/js-signals.js"></script>
		<script type="text/javascript" src="../../../dist/js/hasher.js"></script>
		<script type="text/javascript" src="../../../dist/js/hasher.query.plugin.js"></script>
		<script type="text/javascript" src="../../../dist/js/hasher.stringUtils.plugin.js"></script>
		<title>Untitled</title>
	</head>
	<body>
		<h1 id="qunit-header">Hasher unit test #1</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<script type="text/javascript">
			
			/*
			 * 
			 * 		Hasher JS Unit test #1
			 * 		
			 * 		
			 * 		-----------------------------------------------------------------------
			 * 
			 *		WARNING: 
			 * 			- poor code ahead!
			 * 			- don't use as reference!
			 * 
			 *		----------------------------------------------------------------------- 
			 * 
			 * 		IMPORTANT: 
			 * 			- unit test doesn't work properly on Chrome <= 6 because of browser bug:
			 * 			  http://code.google.com/p/chromium/issues/detail?id=45419
			 * 
			 * 		-----------------------------------------------------------------------
			 * 
			 */
			
			
			location.hash = ''; //resets location.hash
			
			
			/* ==== init hasher test ==== */
			
			test("init hasher", function(){
				stop(500);
				expect(4);
				
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				
				hasher.initialized.add(function(){				
					ok(true, "INIT dispatched");
					
					hasher.initialized.remove(arguments.callee);
					ok(! hasher.initialized.getNumListeners(), "Removed INIT Listener");
					
					start();
				});
				
				ok(hasher.initialized.getNumListeners(), "Added INIT Listener");
				
				hasher.init();
			});
			/* == */
			
			
			/* ==== multiple listeners & changes ==== */
			
			module('multiple listeners & changes');
			
			function multipleTest(){
				
				stop(600);
				expect(32);
				
				function handler1(evt){
					ok(true, 'Called Handler #1');
				}
				
				function handler2(evt){
					ok(true, 'Called Handler #2');
				}
				
				function handler3(evt){
					ok(true, 'Called Handler #3');
				}
				
				hasher.initialized.removeAll();
				hasher.stopped.removeAll();
				hasher.changed.removeAll();
				
				ok(!hasher.changed.getNumListeners(), "No CHANGED Listener");
				
				hasher.changed.add(handler1);
				hasher.changed.add(handler2);
				hasher.changed.add(handler3);
				
				ok(hasher.changed.getNumListeners(), "Has CHANGED Listener");
				
				hasher.setHash('Lorem');
				equals(hasher.getHash(), 'Lorem');
				
				hasher.setHash('Lorem/Ipsum');
				equals(hasher.getHash(), 'Lorem/Ipsum');
				
				hasher.setHash('Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123');
				equals(hasher.getHash(), 'Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123');
				equals(hasher.getHashQuery(), 'foo=bar&ipsum=dolor&n=123&nan=abc123');
				same(hasher.getHashQueryAsObject(), {
					foo: 'bar',
					ipsum: 'dolor',
					n: 123,
					nan: 'abc123'
				});
				equals(hasher.getHashQueryParam('n'), 123);
				equals(hasher.getHashQueryParam('nan'), 'abc123');
				
				hasher.setHash('?foo=bar&ipsum=dolor');
				equals(hasher.getHash(), '?foo=bar&ipsum=dolor');
				equals(hasher.getHashQuery(), 'foo=bar&ipsum=dolor');
				same(hasher.getHashQueryAsObject(), {
					foo: 'bar',
					ipsum: 'dolor'
				});
				equals(hasher.getHashQueryParam('foo'), 'bar');
				
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				hasher.initialized.add(function(e){
					ok(false, "INIT event dispatched by accident"); //shouldn't run
				});
				ok(hasher.initialized.getNumListeners(), "Has INIT Listener");
				
				
				ok(! hasher.stopped.getNumListeners(), "No STOP Listener");
				hasher.stopped.add(function(e){
					ok(false, "STOP event dispatched by accident"); //shouldn't run
				});
				ok(hasher.stopped.getNumListeners(), "Has STOP Listener");
				
				
				hasher.changed.removeAll();
				ok(! hasher.changed.getNumListeners(), "No CHANGED Listener");
				
				
				hasher.initialized.removeAll();
				hasher.stopped.removeAll();
				hasher.changed.removeAll();
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				ok(! hasher.stopped.getNumListeners(), "No STOP Listener");
				
				hasher.setHash(''); //resets hash value
				
				
				start();
				
			}
			
			test('#1', multipleTest);
			
			/* == */
			
			
			var testsHashs = [
				['foo', 'Foo Bar', ''],
				['dolor', 'Dolor Sit Amet', ''],
				['sit-amet/ipsum/?dolor=ipsum&maecennas=ullamcor', 'Sit Amet Ipsum', 'dolor=ipsum&maecennas=ullamcor'],
				['Spï¿½ï¿½ï¿½ï¿½l/Chï¿½rs FTW', 'Spï¿½ï¿½ï¿½ï¿½l Chï¿½rs', ''],
				['/asd', 'Asd', ''],
				['/asd/qwerty/?foo=bar', 'Qwerty / Asd / ? Foo = Bar', 'foo=bar'],
				['/asd/qwerty/', 'Asd Qwerty', '']
			];
			
			
			/* ==== set/get hash/title value ==== */
			
			module('set/get hash/title value');
			
			for(var i=0, t=testsHashs.length; i<t; i++){
				doChangeTest(i);
			}
			
			function doChangeTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var oldHash = (n > 0)? testsHashs[n-1][0] : '';
				var title = testsHashs[n][1];
				var hashQuery = testsHashs[n][2];
				
				var testFn = function(){
					stop(500);
					expect(11);
					
					hasher.initialized.removeAll();
				hasher.stopped.removeAll();
				hasher.changed.removeAll();
					
					ok(! hasher.changed.getNumListeners(), "No CHANGED Listener");
					
					hasher.changed.add(function($newHash, $oldHash){
						ok(true, "CHANGED dispatched");

						ok(($oldHash !== hasher.getHash()), "Hash value really changed.");
						
						hasher.changed.remove(arguments.callee);
						ok( ! hasher.changed.getNumListeners(), "Removed CHANGED Listener");
						
						equals($oldHash, oldHash, "oldHash");
						equals(hasher.getHash(), $newHash, "newHash == hasher.getHash()");
						
						start();
					});
					
					ok(hasher.changed.getNumListeners(), "Attached CHANGED Listener");
					
					hasher.setHash(hash);
					equals(hasher.getHash(), hash, "hasher.setHash() & hasher.getHash()");
					
					var hashArray = hash.split('/');
					
					same(hasher.getHashAsArray(), hashArray, "hasher.getHashAsArray()");
					
					same(hasher.getHashQuery(), hashQuery, "hasher.getHashQuery()");
					
					hasher.setTitle(title);
					equal(hasher.getTitle(), document.title, "hasher.setTitle() & hasher.getTitle()");
				};
				
				test(testName, testFn);
				
			}
			/* == */
			
			
			/* ==== back ==== */
			
			module('back');
			
			var i = testsHashs.length - 1;
			
			while(i--){
				doBackTest(i);
			}
			
			
			function doBackTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(500);
					expect(7);
					
					hasher.initialized.removeAll();
				hasher.stopped.removeAll();
				hasher.changed.removeAll();
					
					ok(!hasher.changed.getNumListeners(), "No CHANGED Listener");
					
					hasher.changed.add(function($newHash, $oldHash){
					
						ok(true, "CHANGED dispatched");
						
						hasher.changed.remove(arguments.callee);
						ok(!hasher.changed.getNumListeners(), "Removed CHANGED Listener");
						
						equals(hasher.getHash(), $newHash, "newHash == hasher.getHash()");
						equals(hasher.getHash(), hash, "hasher.getHash()");
						
						var hashArray = hash.split('/');
						
						same(hasher.getHashAsArray(), hashArray, "hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(hasher.changed.getNumListeners(), "Attached CHANGED Listener");
					
					hasher.back();
				};
				
				test(testName, testFn);
			}
			/* == */
			
			
			/* ==== forward ==== */
			
			module('forward');
			
			for(var i=1, t=testsHashs.length; i<t; i++){
				doForwardTest(i);
			}
			
			
			function doForwardTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(500);
					expect(7);
					
					hasher.initialized.removeAll();
				hasher.stopped.removeAll();
				hasher.changed.removeAll();
					
					ok(!hasher.changed.getNumListeners(), "No CHANGED Listener");
					
					hasher.changed.add(function($newHash, $oldHash){
					
						ok(true, "CHANGED dispatched");
						
						hasher.changed.remove(arguments.callee);
						ok(!hasher.changed.getNumListeners(), "Removed CHANGED Listener");
						
						equals(hasher.getHash(), $newHash, "newHash == hasher.getHash()");
						equals(hasher.getHash(), hash, "hasher.getHash()");
						
						var hashArray = hash.split('/');
						
						same(hasher.getHashAsArray(), hashArray, "hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(hasher.changed.getNumListeners(), "Attached CHANGED Listener");
					
					hasher.forward();
				};
				
				test(testName, testFn);
			}
			/* == */
			
			
			/* ==== init and stop ==== */
			
			module('init and stop');
			
			var stopTest = function(){
				stop(500);
				expect(5);
				
				ok(hasher.isActive(), "Is active");
				ok(! hasher.stopped.getNumListeners(), "No STOP Listener");
				
				hasher.stopped.add(function(evt){
					
					ok(true, "STOP dispatched");
					
					hasher.stopped.remove(arguments.callee);
					
					ok(! hasher.stopped.getNumListeners(), "Removed STOP Listener");
					
					start();
				});
				
				ok(hasher.stopped.getNumListeners(), "Attached STOP Listener");
				hasher.stop();
			};
			
			var stopFailTest = function(){
				stop(500);
				expect(5);
				
				ok(! hasher.isActive(), "Is not active");
				ok(! hasher.stopped.getNumListeners(), "No STOP Listener");
				
				var handler = function(evt){
					ok(false, "STOP dispatched"); //shouldn't happen
					hasher.stopped.removeAll();
					start();
				};
				hasher.stopped.add(handler);
				
				ok(hasher.stopped.getNumListeners(), "Attached STOP Listener");
				hasher.stop();
				hasher.stop();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched STOP event.');
					hasher.stopped.removeAll();
					ok(! hasher.stopped.getNumListeners(), "Removed STOP Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
			};
			
			var initTest = function(){
				stop(500);
				expect(6);
				
				ok(! hasher.isActive(), "Is not active");
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				
				hasher.initialized.add(function(evt){
					ok(hasher.isActive(), "Is active");
					ok(true, "INIT dispatched");
					
					hasher.initialized.remove(arguments.callee);
					
					ok(! hasher.initialized.getNumListeners(), "Removed INIT Listener");
					
					start();
				});
				
				ok(hasher.initialized.getNumListeners(), "Attached INIT Listener");
				hasher.init();
			};
			
			var initFailTest = function(){
				stop(500);
				expect(6);
				
				ok(hasher.isActive(), "Is active");
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				
				var handler = function(evt){
					ok(false, "INIT dispatched"); //shouldn't happen
					hasher.initialized.removeAll();
					start();
				};
				hasher.initialized.add(handler);
				
				ok(hasher.initialized.getNumListeners(), "Attached INIT Listener");
				hasher.init();
				hasher.init();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched INIT event.');
					ok(hasher.isActive(), "Is active");
					hasher.initialized.removeAll();
					ok(! hasher.initialized.getNumListeners(), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
			};
			
			test('stop #1', stopTest);
			test('stop fail #1', stopFailTest);
			test('stop fail #2', stopFailTest);
			test('init #1', initTest);
			test('init fail #1', initFailTest);
			test('init fail #2', initFailTest);
			test('stop #2', stopTest);
			test('init #2', initTest);
			test('stop #3', stopTest);
			
			/* == */
			
			/* ==== disable events ==== */
			
			module('disable');
			
			
			var disableInitTest = function(){
				stop(500);
				expect(6);
				
				ok(! hasher.isActive(), "Is not active");
				ok(! hasher.initialized.getNumListeners(), "No INIT Listener");
				
				var handler = function(evt){
					ok(false, "INIT dispatched"); //shouldn't happen
					hasher.initialized.removeAll();
					start();
				};
				hasher.initialized.add(handler);
				
				ok(hasher.initialized.getNumListeners(), "Attached INIT Listener");
				
				hasher.initialized.disable();
				
				hasher.init();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched INIT event.');
					ok(hasher.isActive(), "Is active");
					hasher.initialized.removeAll();
					ok(! hasher.initialized.getNumListeners(), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			
			var disableChangeTest = function(){
				stop(500);
				expect(6);
				
				ok(hasher.isActive(), "Is active");
				ok(! hasher.changed.getNumListeners(), "No CHANGED Listener");
				
				var handler = function(evt){
					ok(false, "CHANGED dispatched"); //shouldn't happen
					hasher.changed.removeAll();
					start();
				};
				hasher.changed.add(handler);
				
				ok(hasher.changed.getNumListeners(), "Attached CHANGED Listener");
				
				hasher.changed.disable();
				
				hasher.setHash('01');
				hasher.setHash('02');
				hasher.back();
				hasher.forward();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched CHANGED event.');
					ok(hasher.isActive(), "Is active");
					hasher.changed.removeAll();
					ok(! hasher.changed.getNumListeners(), "Removed CHANGED Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			
			var disableStopTest = function(){
				stop(500);
				expect(6);
				
				ok(hasher.isActive(), "Is active");
				ok(! hasher.stopped.getNumListeners(), "No STOP Listener");
				
				var handler = function(evt){
					ok(false, "STOP dispatched"); //shouldn't happen
					hasher.stopped.removeAll();
					start();
				};
				hasher.stopped.add(handler);
				
				ok(hasher.stopped.getNumListeners(), "Attached STOP Listener");
				
				hasher.stopped.disable();
				
				hasher.stop();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched STOP event.');
					ok(! hasher.isActive(), "Is not active");
					hasher.stopped.removeAll();
					ok(! hasher.stopped.getNumListeners(), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			test('disable INIT', disableInitTest);
			test('disable CHANGED', disableChangeTest);
			test('disable STOP', disableStopTest);
			
			/* === */
			
			/* ==== extras ==== */
			
			module('extras');
			
			var accentsTest = function(){
				stop(500);
				expect(3);
				
				var str_arr  = [
					['ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ', 'AAAAAAAECEEEEIIIIDNOOOOOOUUUUYPBaaaaaaaeceeeeiiiiDnoooooouuuuypy'],
					['Special chars ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ for the win!', 'Special chars AAAAAAAECEEEEIIIIDNOOOOOOUUUUYPBaaaaaaaeceeeeiiiiDnoooooouuuuypy for the win!'],
					['Spéçïãl chÂrs fÖr the wîn!', 'Special chArs fOr the win!']
				];
				
				same(hasher.removeAccents(str_arr[0][0]), str_arr[0][1]);
				same(hasher.removeAccents(str_arr[1][0]), str_arr[1][1]);
				same(hasher.removeAccents(str_arr[2][0]), str_arr[2][1]);
				
				start();
			};
			
			var hyphenateTest = function(){
				stop(500);
				expect(3);
				
				var str_arr  = [
					['ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ', 'AAAAAAAECEEEEIIIIDNOOOOOOUUUUYPBaaaaaaaeceeeeiiiiDnoooooouuuuypy'],
					['Special chars ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ for the win!', 'Special-chars-AAAAAAAECEEEEIIIIDNOOOOOOUUUUYPBaaaaaaaeceeeeiiiiDnoooooouuuuypy-for-the-win'],
					['Spéçïãl chÂrs fÖr the wîn!', 'Special-chArs-fOr-the-win'],
					['camelCaseText', 'camel-case-text'],
					['camelCaseText with     mixed  spacing', 'camel-case-text-with-mixed-spacing'],
					['camelCaseText with     mixed  spacing & Spéçïãl chÂrs', 'camel-case-text-with-mixed-spacing-Special-chArs']
				];
				
				same(hasher.hyphenate(str_arr[0][0]), str_arr[0][1]);
				same(hasher.hyphenate(str_arr[1][0]), str_arr[1][1]);
				same(hasher.hyphenate(str_arr[2][0]), str_arr[2][1]);
				
				start();
			};
			
			test('remove accents', accentsTest);
			test('hyphenate', hyphenateTest);
			
			/* === */
			
			/* ==== dispose ==== */
			
			module('dispose');
			
			var disposeTest = function(){
				stop(500);
				expect(5);
				
				ok((hasher), "hasher exists");
				
				hasher.dispose();
				
				ok((! hasher), "! hasher");
				ok(('hasher' in window), "hasher in window");
				ok((hasher === null), "hasher === null");
				ok(!(typeof hasher === 'undefined'), "!(typeof hasher === 'undefined')");
				
				start();
			};
			
			test('dispose', disposeTest);
			
		</script>
	</body>
</html>
